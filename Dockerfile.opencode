FROM node:20-slim

ENV DO_NOT_TRACK=1

WORKDIR /workspace

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    git \
    curl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

RUN npm install -g opencode-ai@0.15.0

RUN groupadd -r opencode && useradd -r -g opencode opencode
RUN mkdir -p /home/opencode && chown -R opencode:opencode /home/opencode /workspace

# Run as root to avoid Bun permission issues creating HOME directory
# TODO: revisit running as non-root once Bun CLI respects existing home directories
USER root

ENV HOME=/root

EXPOSE 3100

ENV OPENCODE_PORT=3100
ENV OPENCODE_HOST=0.0.0.0

HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
  CMD curl -f http://localhost:${OPENCODE_PORT}/health || exit 1

CMD ["opencode", "serve", "-p", "3100", "-h", "0.0.0.0", "--print-logs", "--log-level", "DEBUG"]
